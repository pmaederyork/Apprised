<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>Apprised Chat</title>
    <link rel="icon" type="image/png" href="/static/icons/apprised.png">

    <!-- PWA Support -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Apprised">
    <link rel="apple-touch-icon" href="/static/icons/icon-180x180.png">
    <meta name="theme-color" content="#000000">

    <!-- Apply theme immediately to prevent flash -->
    <script>
        (function() {
            try {
                const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
                let theme = settings.theme || 'dark';
                if (theme === 'auto') {
                    theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }
                document.documentElement.dataset.theme = theme;
            } catch (e) {
                document.documentElement.dataset.theme = 'dark';
            }
        })();
    </script>

    <!-- CSS Files -->
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/mobile.css">
    <link rel="stylesheet" href="/static/css/mobile-layout.css">
    <link rel="stylesheet" href="/static/css/mobile-drawer.css">
    <link rel="stylesheet" href="/static/css/mobile-touch.css">
    <link rel="stylesheet" href="/static/css/mobile-sheets.css">
    <link rel="stylesheet" href="/static/css/mobile-attachments.css">
    <link rel="stylesheet" href="/static/css/mobile-panels.css">
    <link rel="stylesheet" href="/static/css/mobile-review.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="/static/css/chat.css">
    <link rel="stylesheet" href="/static/css/editor.css">
    <link rel="stylesheet" href="/static/css/editor-changes.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/buttons.css">
    <link rel="stylesheet" href="/static/css/auth.css">
    <link rel="stylesheet" href="/static/css/prompt-generator.css">

    <!-- Google API for Picker -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
    <!-- API Key Setup Screen -->
    <div id="apiKeySetup" style="display: none;">
        <div class="api-key-container">
            <button class="api-key-close-btn" id="apiKeyCloseBtn" onclick="skipApiKeySetup()" title="Skip for now">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <h2>Welcome, <span id="setupUserName"></span>!</h2>
            <p class="subtitle">One last step to get started</p>

            <label for="setupApiKeyInput">Your Anthropic API Key</label>
            <input
                type="password"
                id="setupApiKeyInput"
                placeholder="sk-ant-api03-..."
                autocomplete="off"
            />

            <div class="api-key-help">
                Don't have an API key? <a href="https://console.anthropic.com/" target="_blank">Get one here</a>
            </div>

            <div class="api-key-error" id="apiKeyError"></div>

            <button class="save-api-key-btn" id="saveApiKeyBtn" onclick="saveApiKey()">
                Save & Continue
            </button>

            <button class="skip-api-key-btn" id="skipApiKeyBtn" onclick="skipApiKeySetup()">
                Skip for now
            </button>
            <p class="skip-hint">You can add your API key later in Settings. Chat will be disabled until then.</p>
        </div>
    </div>

    <div class="app-container">
        <!-- Drawer backdrop for mobile -->
        <div class="drawer-backdrop" id="drawerBackdrop"></div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img id="appLogo" class="app-logo" src="/static/icons/apprised.png" alt="Apprised" />
            </div>
            <div class="sidebar-content" id="sidebarContent">
                <div class="model-selector">
                    <select id="modelSelect" class="model-select" title="Select AI Model">
                        <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5</option>
                        <option value="claude-opus-4-5-20251101">Claude Opus 4.5</option>
                        <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5</option>
                    </select>
                </div>
                <div class="system-prompt-section">
                    <div class="section-header" id="systemPromptHeader">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="collapse-icon" id="systemPromptCollapse">‚ñº</span>
                            <span class="section-title" style="margin: 0;">AGENTS</span>
                        </div>
                        <button class="add-prompt-btn" id="addPromptBtn" title="Add new system prompt">+</button>
                    </div>
                    <div class="system-prompt-list" id="systemPromptList">
                        <!-- System prompt items will be populated by JavaScript -->
                    </div>
                </div>
                <div class="conversations-section">
                    <div class="section-header" id="conversationsHeader">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="collapse-icon" id="conversationsCollapse">‚ñº</span>
                            <span class="section-title" style="margin: 0;">CONVERSATIONS</span>
                        </div>
                        <button class="new-chat-btn" id="newChatBtn" title="Start new chat">+</button>
                    </div>
                    <div class="conversations-list" id="chatList">
                        <!-- Chat items will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="documents-section">
                    <div class="section-header" id="documentsHeader">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="collapse-icon" id="documentsCollapse">‚ñº</span>
                            <span class="section-title" style="margin: 0;">DOCUMENTS</span>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="import-drive-btn" id="importFromDriveBtn" title="Import from Google Drive">
                                <img src="/static/assets/gdrive_icon.webp" alt="Google Drive" style="width: 16px; height: 16px;">
                            </button>
                            <button class="add-document-btn" id="addDocumentBtn" title="Add new document">+</button>
                        </div>
                    </div>
                    <div class="documents-list" id="documentsList">
                        <!-- Document items will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="tools-section">
                    <div class="section-title">TOOLS</div>
                    <div class="tool-item">
                        <div class="tool-content">
                            <span class="tool-name">Web Search</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="webSearchToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="tool-item">
                        <div class="tool-content">
                            <span class="tool-name">Screenshare</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="screenshareToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sidebar-footer">
                <div class="user-profile" id="userProfile" style="display: none;">
                    <img id="userAvatarFooter" class="user-avatar" src="" alt="User">
                    <div class="user-info">
                        <span class="user-name" id="userNameFooter"></span>
                    </div>
                </div>

                <!-- User Menu Dropdown -->
                <div class="user-menu-dropdown" id="userMenuDropdown" style="display: none;">
                    <div class="user-menu-item" id="menuSettings">
                        <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6m0-6h6m-6 0H6m6-6a9 9 0 0 1 0 18 9 9 0 0 1 0-18z"/>
                        </svg>
                        <span>Settings</span>
                    </div>
                    <div class="user-menu-item" id="menuLogout">
                        <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        <span>Log out</span>
                    </div>
                </div>
            </div>
            <div class="sidebar-resize-handle" id="sidebarResizeHandle"></div>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <!-- Hamburger button for mobile drawer -->
                <button class="hamburger-btn" id="hamburgerBtn" aria-label="Open menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <input type="text" class="chat-title" id="chatTitle" value="New Chat" />

                <div class="chat-header-actions">
                    <div class="agent-controls">
                        <div class="agent-selector" id="agentSelector">
                            <span class="agent-selector-text">No Agents</span>
                        </div>
                        <button class="add-agent-btn" id="addAgentBtn" title="Add Agent">+</button>
                    </div>
                    <div class="turns-control">
                        <label for="turnsSelector" class="turns-label">Turns:</label>
                        <select id="turnsSelector" class="turns-selector">
                            <option value="auto" selected>Auto</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <!-- Mobile chat collapse button -->
                    <button class="mobile-btn chat-collapse-btn" id="chatCollapseBtn" title="Collapse chat">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Collapsed chat bar - shown when chat is minimized -->
            <div class="mobile-collapsed-chat-bar" id="collapsedChatBar">
                <span>Chat</span>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message claude">
                    <div class="message-bubble">
                        Hello! I'm Claude. Ask me anything and I'll do my best to help you.
                    </div>
                </div>
            </div>
            <div class="loading" id="loading">
                <span class="loading-dots">Claude is thinking...</span>
            </div>
            <div class="file-preview-area" id="filePreviewArea" style="display: none;">
                <!-- File thumbnails will be populated here -->
            </div>
            <div class="screenshare-preview-container" id="screensharePreviewContainer" style="display: none;">
                <div class="screenshare-preview-item">
                    <img class="screenshare-preview-image" id="screensharePreviewImage" alt="Live Screenshot">
                    <span class="screenshare-preview-label">Live Screenshot</span>
                </div>
            </div>
            <div class="chat-input-container">
                <textarea id="messageInput" placeholder="Reply to Claude..." rows="1"></textarea>
                <input type="file" id="fileInput" multiple style="display: none;" />
                <!-- Mobile camera input -->
                <input type="file" id="mobileCameraInput" accept="image/*" capture="environment" style="display: none;">
                <!-- Mobile photo library input -->
                <input type="file" id="mobilePhotoInput" accept="image/*" style="display: none;">
                <!-- Mobile file picker input -->
                <input type="file" id="mobileFileInput" accept="*/*" multiple style="display: none;">
                <span id="docContextIndicator" class="doc-context-indicator" title="Document context active">‚úì</span>
                <button id="fileBtn" title="Attach files">üìé</button>
                <button id="sendBtn">‚Üó</button>
            </div>
        </div>

        <div class="system-prompt-editor" id="systemPromptEditor">
            <div class="editor-header">
                <input type="text" class="editor-title" id="editorTitle" placeholder="System Prompt Name" />
                <div class="editor-actions">
                    <button class="editor-btn" id="exitEditorBtn">Back to Chat</button>
                </div>
            </div>
            <div class="editor-content">
                <!-- Prompt Generator Bar -->
                <div class="prompt-generator-bar" id="promptGeneratorBar">
                    <div class="generator-header" id="generatorHeader">
                        <span class="collapse-icon" id="generatorCollapse">‚ñº</span>
                        <span class="generator-title">GENERATE SYSTEM PROMPT</span>
                    </div>
                    <div class="generator-content" id="generatorContent">
                        <div class="generator-top-row">
                            <label for="promptDescriptionInput" class="generator-label">
                                Describe what you want this agent to do:
                            </label>
                            <div class="generator-actions">
                                <button id="generatePromptBtn" class="generate-btn">
                                    ‚ú® Generate
                                </button>
                                <button id="clearDescriptionBtn" class="clear-description-btn">
                                    Clear
                                </button>
                            </div>
                        </div>
                        <textarea
                            id="promptDescriptionInput"
                            class="prompt-description-input"
                            placeholder='e.g., "A Python expert that helps debug code and explain best practices"'
                            rows="2"
                        ></textarea>
                        <div id="generatorStatus" class="generator-status" style="display: none;"></div>
                    </div>
                </div>

                <textarea class="system-prompt-textarea" id="systemPromptTextarea" placeholder="Enter your system prompt here..."></textarea>
            </div>
        </div>

        <div class="document-editor" id="documentEditor">
            <!-- Mobile editor header -->
            <div class="mobile-editor-header">
                <!-- Hamburger for mobile drawer (when doc is open) -->
                <button class="hamburger-btn editor-hamburger" id="editorHamburgerBtn" aria-label="Open menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="mobile-editor-title">
                    <input type="text" class="editor-doc-title" id="mobileDocumentTitle" placeholder="Document Name" />
                </div>
                <div class="mobile-editor-actions">
                    <!-- Hidden for now - opens doc in GDrive, not reliable on mobile -->
                    <button class="mobile-btn gdrive-status-btn" id="mobileGdriveStatusBtn" title="Google Drive status" style="display: none;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.01 1.485c-2.082 0-3.754.02-3.743.047.01.02 1.708 3.001 3.774 6.62l3.76 6.574h3.76c2.081 0 3.753-.02 3.742-.047-.01-.02-1.708-3.001-3.774-6.62l-3.76-6.574h-3.759zm-4.76 1.73a789.828 789.861 0 00-3.63 6.319L0 15.828l1.89 3.293 1.89 3.291 3.612-6.319 3.612-6.318-1.89-3.271c-1.04-1.8-1.92-3.272-1.953-3.271-.033 0-1.698 2.845-3.7 6.319l-3.638 6.317 1.89 3.291 1.89 3.291h7.234l3.63-6.319 3.63-6.318-3.63-6.319c-1.996-3.474-3.66-6.318-3.693-6.319-.033 0-1.698 2.845-3.7 6.319l-3.638 6.317h3.76l1.87-3.265c1.028-1.795 1.87-3.291 1.87-3.324 0-.033-.84-1.53-1.87-3.325L8.14.044c-.046-.025-.07.003-.11.009-.04.006-.08.016-.08.016a.045.045 0 00.013.006l3.807 6.62z"/>
                        </svg>
                    </button>
                    <button class="mobile-btn pull-btn" id="mobilePullBtn" title="Pull from Drive">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </button>
                    <button class="mobile-btn save-btn" id="mobileSaveBtn" title="Save">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                    </button>
                    <button class="mobile-btn toolbar-toggle-btn" id="toolbarToggleBtn" title="Toggle toolbar">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="4" y1="9" x2="20" y2="9"></line>
                            <line x1="4" y1="15" x2="20" y2="15"></line>
                            <line x1="10" y1="3" x2="8" y2="21"></line>
                            <line x1="16" y1="3" x2="14" y2="21"></line>
                        </svg>
                    </button>
                    <button class="mobile-btn close-btn" id="mobileCloseEditorBtn" title="Close document">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="editor-header">
                <input type="text" class="editor-title" id="documentTitle" placeholder="Document Name" />
                <span id="driveSyncIndicator" class="drive-sync-indicator" style="display: none; margin-left: 8px;"></span>
                <div class="editor-actions">
                    <a id="openInDriveBtn" class="open-in-drive-btn" href="#" target="_blank" style="display: none; margin-right: 8px;" title="Open in Google Drive">
                        <img src="/static/assets/gdrive_icon.webp" alt="Open in Drive" style="width: 28px; height: 28px;">
                    </a>
                    <button class="editor-btn save-drive" id="saveToDriveBtn" title="Save to Google Drive">Save</button>
                    <button class="editor-btn pull-drive" id="documentSyncBtn">Pull</button>
                    <button class="editor-btn close-document" id="closeDocumentBtn">Close</button>
                </div>
            </div>
            <div class="markdown-toolbar" id="markdownToolbar">
                <button class="markdown-btn" id="undoBtn" title="Undo (Ctrl+Z)" data-format="undo">‚Ü∂</button>
                <button class="markdown-btn" id="redoBtn" title="Redo (Ctrl+Y)" data-format="redo">‚Ü∑</button>
                <span class="toolbar-separator"></span>
                <button class="markdown-btn" id="boldBtn" title="Bold (Ctrl+B)" data-format="bold">B</button>
                <button class="markdown-btn" id="italicBtn" title="Italic (Ctrl+I)" data-format="italic">I</button>
                <button class="markdown-btn" id="underlineBtn" title="Underline (Ctrl+U)" data-format="underline">U</button>
                <button class="markdown-btn" id="listBtn" title="Unordered List (Ctrl+L)" data-format="list">‚Ä¢</button>
                <button class="markdown-btn" id="orderedListBtn" title="Ordered List (Ctrl+Shift+L)" data-format="orderedList">#</button>
                <button class="markdown-btn" id="strikeBtn" title="Strikethrough (Ctrl+Shift+X)" data-format="strike">S</button>
                <span class="toolbar-separator"></span>
                <button class="markdown-btn" id="indentBtn" title="Increase Indent (Ctrl+])">‚Üí</button>
                <button class="markdown-btn" id="outdentBtn" title="Decrease Indent (Ctrl+[)">‚Üê</button>
                <span class="toolbar-separator"></span>
                <select class="font-size-select" id="fontSizeSelect" title="Font Size">
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="14">14</option>
                    <option value="16">16</option>
                    <option value="18">18</option>
                    <option value="20">20</option>
                    <option value="24">24</option>
                    <option value="28">28</option>
                    <option value="32">32</option>
                    <option value="36">36</option>
                    <option value="48">48</option>
                    <option value="60">60</option>
                    <option value="72">72</option>
                </select>
                <span class="toolbar-separator"></span>
                <select class="font-family-select" id="fontFamilySelect" title="Font Family">
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Verdana">Verdana</option>
                </select>
                <span class="toolbar-separator"></span>
                <!-- Format Dropdown -->
                <select id="formatSelect" class="format-dropdown" title="Text Format">
                    <option value="p">P</option>
                    <option value="t">T</option>
                    <option value="h1">H1</option>
                    <option value="h2">H2</option>
                    <option value="h3">H3</option>
                </select>
                <span class="toolbar-separator"></span>
                <select class="text-align-select" id="textAlignSelect" title="Text Alignment">
                    <option value="">Align</option>
                    <option value="left">‚¨Ö Left</option>
                    <option value="center">‚¨å Center</option>
                    <option value="right">‚û° Right</option>
                    <option value="justify">‚â° Justify</option>
                </select>
                <span class="toolbar-separator"></span>
                <div class="spacing-dropdown">
                    <button class="toolbar-btn spacing-dropdown-btn" id="spacingDropdownBtn" title="Line & Paragraph Spacing">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M2 2h12v1H2V2zm0 6h12v1H2V8zm0 6h12v1H2v-1z"/>
                        </svg>
                    </button>
                    <div class="spacing-dropdown-menu" id="spacingDropdownMenu" style="display: none;">
                        <div class="spacing-menu-item" data-action="line-spacing" data-value="1">
                            <span class="checkmark">‚úì</span>
                            <span>Single</span>
                        </div>
                        <div class="spacing-menu-item" data-action="line-spacing" data-value="1.15">
                            <span class="checkmark">‚úì</span>
                            <span>1.15</span>
                        </div>
                        <div class="spacing-menu-item" data-action="line-spacing" data-value="1.5">
                            <span class="checkmark">‚úì</span>
                            <span>1.5</span>
                        </div>
                        <div class="spacing-menu-item" data-action="line-spacing" data-value="2">
                            <span class="checkmark">‚úì</span>
                            <span>Double</span>
                        </div>
                        <div class="spacing-menu-separator"></div>
                        <div class="spacing-menu-item" data-action="space-before">
                            <span class="checkmark">‚úì</span>
                            <span>Add space before paragraph</span>
                        </div>
                        <div class="spacing-menu-item" data-action="space-after">
                            <span class="checkmark">‚úì</span>
                            <span>Add space after paragraph</span>
                        </div>
                    </div>
                </div>
                <span class="toolbar-separator"></span>
                <label class="auto-accept-toggle" title="Auto-accept Claude's edits">
                    <input type="checkbox" id="autoAcceptEditsToggle">
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Accept All</span>
                </label>

            </div>
            <div class="editor-content">
                <div class="document-textarea" id="documentTextarea" data-placeholder="Start writing..."></div>
            </div>
        </div>

        <!-- Claude Change Review Panel -->
        <div id="documentChangeReview" class="change-review-panel" style="display: none;" tabindex="-1">
            <!-- Header -->
            <div class="review-header">
                <h3>Review Claude's Changes</h3>
            </div>

            <!-- Navigation Controls -->
            <div class="review-controls">
                <button id="prevChangeBtn">‚Üê Previous</button>
                <button id="nextChangeBtn">Next ‚Üí</button>
                <span class="change-position" id="changePosition">Change 1 of 1</span>
            </div>

            <!-- Action Buttons -->
            <div class="review-actions">
                <button id="acceptChangeBtn" class="accept-btn">‚úì Accept</button>
                <button id="rejectChangeBtn" class="reject-btn">‚úó Reject</button>
                <button id="acceptAllBtn" class="accept-all-btn">Accept All</button>
                <button id="rejectAllBtn" class="reject-all-btn">Reject All</button>
            </div>

            <!-- Current Change Detail -->
            <div class="current-change-detail">
                <div class="change-type-indicator" id="changeTypeIndicator">MODIFY</div>
                <div class="change-content-preview" id="changeContentPreview"></div>
            </div>

            <!-- Keyboard Shortcuts Help -->
            <div class="review-shortcuts-help">
                <h4>Keyboard Shortcuts</h4>
                <ul>
                    <li><kbd>‚Üí</kbd> Next change</li>
                    <li><kbd>‚Üê</kbd> Previous change</li>
                    <li><kbd>Enter</kbd> Accept change</li>
                    <li><kbd>Delete</kbd> Reject change</li>
                    <li><kbd>Ctrl+A</kbd> Accept all</li>
                    <li><kbd>Ctrl+R</kbd> Reject all</li>
                    <li><kbd>Esc</kbd> Cancel review</li>
                </ul>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="settings-modal" id="settingsModal" style="display: none;">
            <div class="settings-modal-content">
                <div class="settings-header">
                    <h3>Settings</h3>
                    <button class="close-settings-btn" id="closeSettingsBtn">√ó</button>
                </div>
                <div class="settings-body">
                    <!-- Theme Section -->
                    <div class="settings-section appearance-settings-section">
                        <h4 class="settings-section-title">Theme</h4>
                        <div class="settings-section-content">
                            <select id="themeSelect" class="theme-select">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="auto">System</option>
                            </select>
                        </div>
                    </div>

                    <!-- API Key Section -->
                    <div class="settings-section api-settings-section">
                        <h4 class="settings-section-title">Anthropic API Key</h4>
                        <div class="settings-section-content">
                            <div class="api-key-input-container">
                                <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..." />
                                <button class="show-hide-btn" id="showHideBtn" title="Show/Hide API Key">üëÅÔ∏è</button>
                            </div>
                            <div class="api-key-status" id="apiKeyStatus"></div>
                            <div class="api-key-actions">
                                <button class="save-api-key-btn" id="saveApiKeyBtnModal">Save API Key</button>
                                <button class="delete-api-key-btn" id="deleteApiKeyBtn">Delete API Key</button>
                            </div>
                        </div>
                    </div>

                    <!-- Google Drive Integration Section -->
                    <div class="settings-section gdrive-settings-section">
                        <h4 class="settings-section-title">Google Drive</h4>
                        <div class="settings-section-content">
                            <div id="gdriveStatusContainer" class="gdrive-status-container">
                                <span id="gdriveStatusIcon" class="gdrive-status-icon">‚òÅÔ∏è</span>
                                <span id="gdriveStatusText" class="gdrive-status-text">Not connected</span>
                            </div>
                            <div class="gdrive-actions">
                                <button id="gdriveConnectBtn" class="gdrive-connect-btn">Enable Drive Access</button>
                                <button id="gdriveDisconnectBtn" class="gdrive-disconnect-btn" style="display: none;">Disconnect Drive</button>
                            </div>
                        </div>
                        <h4 class="settings-section-title settings-subsection-title">Default Drive Folder</h4>
                        <div class="settings-section-content">
                            <div class="gdrive-folder-box">
                                <div class="gdrive-folder-row">
                                    <span id="gdriveFolderName" class="gdrive-folder-name">None (saves to root)</span>
                                    <button id="gdriveFolderBtn" class="gdrive-folder-btn">Select Folder</button>
                                </div>
                            </div>
                            <div class="gdrive-help-text">
                                Connect Google Drive to save and import previously created documents.
                                Apprised only accesses files you create in the app, not your broader
                                files even though they are visible in the picker.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div class="settings-modal" id="helpModal" style="display: none;">
            <div class="settings-modal-content">
                <div class="settings-header">
                    <h3>Apprised Chat - Help & Shortcuts</h3>
                    <button class="close-settings-btn" id="closeHelpBtn">√ó</button>
                </div>
                <div class="settings-body">
                    <!-- App Features Section - MOVED TO TOP -->
                    <div class="settings-section">
                        <h4 class="settings-section-title">‚ú® Key Features</h4>
                        <div class="settings-section-content">
                            <ul class="feature-list">
                                <li><strong>Agent Document Editor:</strong> Ask agents to reformat, add, remove, and generate text</li>
                                <li><strong>Review Edits:</strong> Preview, accept or reject inline edits made by agents</li>
                                <li><strong>Multi-Agent System:</strong> Create custom agents with specialized system prompts</li>
                                <li><strong>Multi-Turn Reasoning:</strong> Configure 1-10 reasoning turns for complex tasks</li>
                                <li><strong>Web Search:</strong> Enable Claude to search the web for current information</li>
                                <li><strong>File Upload:</strong> Attach images and documents to your messages</li>
                                <li><strong>Screenshare:</strong> Capture and share screenshots with Claude</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Chat Shortcuts Section -->
                    <div class="settings-section">
                        <h4 class="settings-section-title">üí¨ Chat Shortcuts</h4>
                        <div class="settings-section-content">
                            <div class="shortcut-grid">
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Enter</span>
                                    <span class="shortcut-description">Send message</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Shift + Enter</span>
                                    <span class="shortcut-description">New line in message</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Tab</span>
                                    <span class="shortcut-description">Copy latest Claude message to document</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">‚Üë</span>
                                    <span class="shortcut-description">Copy last user message to input</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Escape</span>
                                    <span class="shortcut-description">Clear chat input</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Ctrl + C</span>
                                    <span class="shortcut-description">Interrupt streaming response</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Document Editor Shortcuts Section -->
                    <div class="settings-section">
                        <h4 class="settings-section-title">üìù Document Editor Shortcuts</h4>
                        <div class="settings-section-content">
                            <div class="shortcut-grid">
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Ctrl/Cmd + B</span>
                                    <span class="shortcut-description">Bold text</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Ctrl/Cmd + I</span>
                                    <span class="shortcut-description">Italic text</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Ctrl/Cmd + U</span>
                                    <span class="shortcut-description">Underline text</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Ctrl/Cmd + L</span>
                                    <span class="shortcut-description">Unordered list</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Ctrl + Shift + L</span>
                                    <span class="shortcut-description">Ordered list</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Ctrl + Shift + X</span>
                                    <span class="shortcut-description">Strikethrough</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Ctrl/Cmd + Z</span>
                                    <span class="shortcut-description">Undo</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Ctrl/Cmd + Y</span>
                                    <span class="shortcut-description">Redo</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Change Review Shortcuts Section -->
                    <div class="settings-section">
                        <h4 class="settings-section-title">üîç AI Change Review Shortcuts</h4>
                        <div class="settings-section-content">
                            <div class="shortcut-grid">
                                <div class="shortcut-item">
                                    <span class="shortcut-key">‚Üê / ‚Üí</span>
                                    <span class="shortcut-description">Navigate changes</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Enter / Y</span>
                                    <span class="shortcut-description">Accept current change</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Delete / N</span>
                                    <span class="shortcut-description">Reject current change</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Ctrl/Cmd + A</span>
                                    <span class="shortcut-description">Accept all changes</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Ctrl/Cmd + R</span>
                                    <span class="shortcut-description">Reject all changes</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Escape</span>
                                    <span class="shortcut-description">Cancel review and revert</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Global Shortcuts Section -->
                    <div class="settings-section">
                        <h4 class="settings-section-title">‚ö° Global Shortcuts</h4>
                        <div class="settings-section-content">
                            <div class="shortcut-grid">
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Ctrl/Cmd + N</span>
                                    <span class="shortcut-description">New chat</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Escape</span>
                                    <span class="shortcut-description">Close modals/editors</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="shortcut-key">Enter</span>
                                    <span class="shortcut-description">Save inline edit</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Key Required Notification -->
        <div class="api-key-notification" id="apiKeyNotification" style="display: none;">
            <div class="notification-content">
                <h3>API Key Required</h3>
                <p>Please add your Anthropic API key in Settings before using the chat.</p>
                <button class="open-settings-btn" id="openSettingsFromNotification">Open Settings</button>
            </div>
        </div>

    </div>

    <!-- Bottom sheet container for model selector -->
    <div class="bottom-sheet" id="modelBottomSheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h3>Select Model</h3>
        </div>
        <div class="bottom-sheet-content" id="modelSheetContent">
            <!-- Model options populated by JS -->
        </div>
    </div>

    <!-- Bottom sheet container for agent selector -->
    <div class="bottom-sheet" id="agentBottomSheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h3>Active Agents</h3>
        </div>
        <div class="bottom-sheet-content" id="agentSheetContent">
            <!-- Agent list populated by JS -->
        </div>
    </div>

    <!-- Bottom sheet for theme selector -->
    <div class="bottom-sheet" id="themeBottomSheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h3>Select Theme</h3>
        </div>
        <div class="bottom-sheet-content" id="themeSheetContent">
            <!-- Theme options populated by JS -->
        </div>
    </div>

    <!-- Bottom sheet for prompt selector (Add Agent modal) -->
    <div class="bottom-sheet" id="promptBottomSheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h3>Select System Prompt</h3>
        </div>
        <div class="bottom-sheet-content" id="promptSheetContent">
            <!-- Prompt options populated by JS -->
        </div>
    </div>

    <!-- Bottom sheet for font size selector -->
    <div class="bottom-sheet" id="fontSizeBottomSheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h3>Font Size</h3>
        </div>
        <div class="bottom-sheet-content" id="fontSizeSheetContent">
            <!-- Font size options populated by JS -->
        </div>
    </div>

    <!-- Bottom sheet for font family selector -->
    <div class="bottom-sheet" id="fontFamilyBottomSheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h3>Font</h3>
        </div>
        <div class="bottom-sheet-content" id="fontFamilySheetContent">
            <!-- Font family options populated by JS -->
        </div>
    </div>

    <!-- Bottom sheet for text format/header selector -->
    <div class="bottom-sheet" id="formatBottomSheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h3>Text Format</h3>
        </div>
        <div class="bottom-sheet-content" id="formatSheetContent">
            <!-- Format options populated by JS -->
        </div>
    </div>

    <!-- Bottom sheet for text alignment selector -->
    <div class="bottom-sheet" id="alignBottomSheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h3>Text Alignment</h3>
        </div>
        <div class="bottom-sheet-content" id="alignSheetContent">
            <!-- Alignment options populated by JS -->
        </div>
    </div>

    <!-- Bottom sheet backdrop -->
    <div class="bottom-sheet-backdrop" id="bottomSheetBackdrop"></div>

    <!-- Mobile attachment menu -->
    <div class="mobile-attachment-menu" id="mobileAttachmentMenu">
        <div class="attachment-menu-item" id="attachCameraBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </svg>
            <span>Camera</span>
        </div>
        <div class="attachment-menu-item" id="attachPhotoBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <span>Photo Library</span>
        </div>
        <div class="attachment-menu-item" id="attachFileBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <span>Files</span>
        </div>
    </div>
    <div class="mobile-attachment-backdrop" id="mobileAttachmentBackdrop"></div>

    <!-- Full screen modal for system prompts -->
    <div class="mobile-fullscreen-modal" id="systemPromptModal">
        <div class="fullscreen-modal-header">
            <button class="modal-back-btn" id="systemPromptModalBack">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <h3>Edit System Prompt</h3>
            <button class="modal-save-btn" id="systemPromptModalSave">Save</button>
        </div>
        <div class="fullscreen-modal-content" id="systemPromptModalContent">
            <!-- System prompt editor content -->
        </div>
    </div>

    <!-- JavaScript Modules -->
    <script src="/static/js/mobile.js"></script>
    <script src="/static/js/mobile-drawer.js"></script>
    <script src="/static/js/mobile-touch.js"></script>
    <script src="/static/js/mobile-sheets.js"></script>
    <script src="/static/js/mobile-attachments.js"></script>
    <script src="/static/js/mobile-keyboard.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/storage.js"></script>
    <script src="/static/js/storage-sync.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/components.js"></script>
    <script src="/static/js/ui.js"></script>
    <script src="/static/js/document-editing-instructions.js"></script>
    <script src="/static/js/chat.js"></script>
    <script src="/static/js/systemPrompts.js"></script>
    <script src="/static/js/promptGenerator.js"></script>
    <script src="/static/js/moderator.js"></script>
    <script src="/static/js/agents.js"></script>
    <script src="/static/js/purify.min.js"></script>
    <script src="/static/js/squire-raw.js"></script>
    <script src="/static/js/headerFormats.js"></script>
    <script src="/static/js/element-ids.js"></script>
    <script src="/static/js/documents.js"></script>
    <script src="/static/js/claude-changes.js"></script>
    <script src="/static/js/tools.js"></script>
    <script src="/static/js/screenshare.js"></script>
    <script src="/static/js/files.js"></script>
    <script src="/static/js/gdrive.js"></script>
    <script src="/static/js/settings.js"></script>
    <script src="/static/js/help.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>