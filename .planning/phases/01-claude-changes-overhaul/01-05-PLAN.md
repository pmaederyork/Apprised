---
phase: 01-claude-changes-overhaul
plan: 05
type: execute
wave: 3
depends_on: [01-01, 01-04]
files_modified:
  - backend/static/js/chat.js
autonomous: true

must_haves:
  truths:
    - "System prompt instructs Claude to use targetId when available"
    - "System prompt documents pattern operation syntax"
    - "Claude can choose between element-specific and pattern-based changes"
  artifacts:
    - path: "backend/static/js/chat.js"
      provides: "Updated document editing instructions"
      contains: "targetId"
      contains: "delete-pattern"
  key_links:
    - from: "backend/static/js/chat.js"
      to: "Claude API"
      via: "System prompt in sendMessage()"
      pattern: "documentEditingInstructions"
---

<objective>
Update Claude's system prompt to use targetId-based targeting and pattern operations.

Purpose: Instruct Claude how to use the new element ID system and pattern syntax for more reliable and comprehensive document editing.

Output: Updated documentEditingInstructions in chat.js with targetId and pattern syntax.
</objective>

<execution_context>
@/Users/pax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pax/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-claude-changes-overhaul/01-CONTEXT.md
@.planning/phases/01-claude-changes-overhaul/01-RESEARCH.md
@.planning/phases/01-claude-changes-overhaul/01-04-SUMMARY.md
@backend/static/js/chat.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add element ID targeting instructions to system prompt</name>
  <files>backend/static/js/chat.js</files>
  <action>
Modify the `documentEditingInstructions` string in chat.js (around line 343, inside sendMessage()). Add a new section for element ID targeting AFTER the existing CRITICAL RULES section and BEFORE the EXAMPLES section:

Find the section that ends with:
```
The user will review each change with visual highlighting...
```

Insert the following BEFORE that closing line:

```javascript
═══════════════════════════════════════════════════════════════════════════
ELEMENT IDENTIFICATION (ADVANCED)
═══════════════════════════════════════════════════════════════════════════

Each block element in the document has a stable 'data-edit-id' attribute.
When proposing changes, you can include targetId for more reliable matching:

<change type="delete" targetId="550e8400-e29b-41d4-a716-446655440000">
<original><p data-edit-id="550e8400-e29b-41d4-a716-446655440000">Text to delete</p></original>
</change>

<change type="modify" targetId="550e8400-e29b-41d4-a716-446655440001">
<original><p data-edit-id="550e8400-e29b-41d4-a716-446655440001">Original</p></original>
<new><p>Modified</p></new>
</change>

For ADD operations, use anchorTargetId to specify the anchor element:
<change type="add" anchorTargetId="550e8400-e29b-41d4-a716-446655440002" insertAfter="<p data-edit-id=\"...\">Anchor</p>">
<new><p>New content</p></new>
</change>

IMPORTANT:
- Copy the exact data-edit-id value from the element in the document
- If you cannot determine the ID, omit targetId and use content matching (still works)
- The targetId enables reliable targeting even after document modifications

═══════════════════════════════════════════════════════════════════════════
PATTERN OPERATIONS (BULK CHANGES)
═══════════════════════════════════════════════════════════════════════════

For bulk operations (e.g., "delete all empty paragraphs"), use pattern syntax
instead of listing each element individually:

<change type="delete-pattern" pattern="empty-paragraphs">
</change>

The client will find and process ALL matching elements automatically.

Available patterns:
- empty-paragraphs: Paragraphs with no text content
- empty-lines: Any block element (p, div, h1-h6) with no content
- duplicate-breaks: Consecutive <br> tags
- trailing-whitespace: Elements with excessive trailing spaces

WHEN TO USE PATTERNS:
- User asks to remove "all" of something (all empty lines, all blank paragraphs)
- User wants to clean up formatting across the entire document
- Operation applies to multiple similar elements

WHEN NOT TO USE PATTERNS:
- User specifies a particular element by content
- Change requires different modifications per element
- User wants selective removal (only some empty paragraphs)

Pattern example:
User: "Remove all the empty paragraphs from this document"

<document_edit>
<change type="delete-pattern" pattern="empty-paragraphs">
</change>
</document_edit>

The system will find ALL empty paragraphs and show them for review.

```

Make sure to properly escape any quotes within the template literal or use backticks appropriately.
  </action>
  <verify>
1. In chat.js, search for "ELEMENT IDENTIFICATION" - should exist in documentEditingInstructions
2. Search for "targetId" - should appear in the instructions
3. Search for "delete-pattern" - should appear in the instructions
4. Search for "empty-paragraphs" - should appear in available patterns list
  </verify>
  <done>
System prompt updated with element ID targeting and pattern operation syntax instructions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add example showing targetId usage</name>
  <files>backend/static/js/chat.js</files>
  <action>
Add an example to the EXAMPLES section showing proper targetId usage. Find the existing examples section and add one more example:

After the existing examples, add:

```javascript
═══════════════════════════════════════════════════════════════════════════
EXAMPLE: Using targetId for reliable targeting
═══════════════════════════════════════════════════════════════════════════

Example 13: MODIFY with targetId
User: "Make this paragraph bold" (user has selected/indicated a specific paragraph)
Document has: <p data-edit-id="abc-123-def">This is important text.</p>

Response: "I'll make that paragraph bold:

<document_edit>
<change type="modify" targetId="abc-123-def">
<original><p data-edit-id="abc-123-def">This is important text.</p></original>
<new><p><strong>This is important text.</strong></p></new>
</change>
</document_edit>"

Note: The targetId ensures the correct paragraph is modified even if there are similar paragraphs in the document.

Example 14: Pattern operation for bulk cleanup
User: "Clean up this document - remove all empty lines"

Response: "I'll remove all empty lines:

<document_edit>
<change type="delete-pattern" pattern="empty-lines">
</change>
</document_edit>"

Note: The system will find ALL empty lines automatically. No need to list each one.
```

These examples demonstrate the new features in context.
  </action>
  <verify>
1. Search for "Example 13" or "MODIFY with targetId" in chat.js
2. Search for "Example 14" or "Pattern operation" in chat.js
3. Examples show the correct XML syntax with targetId and pattern attributes
  </verify>
  <done>
Examples added showing targetId usage and pattern operations for Claude's reference.
  </done>
</task>

</tasks>

<verification>
1. Open app with document editor
2. Open document with multiple paragraphs
3. Ask Claude: "Delete the second paragraph" - Claude should include targetId in response
4. Ask Claude: "Remove all empty lines" - Claude should use delete-pattern syntax
5. Verify Claude's response includes the correct XML structure
6. Verify changes are detected and processed correctly by the system
</verification>

<success_criteria>
- Claude uses targetId when referencing specific elements
- Claude uses pattern syntax for bulk operations
- Pattern operations result in all matches being found client-side
- Backward compatible - old content-only format still works
- Instructions are clear enough for Claude to use correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-claude-changes-overhaul/01-05-SUMMARY.md`
</output>
