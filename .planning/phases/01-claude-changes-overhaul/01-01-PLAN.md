---
phase: 01-claude-changes-overhaul
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/static/js/element-ids.js
  - backend/static/js/documents.js
  - backend/templates/index.html
autonomous: true

must_haves:
  truths:
    - "All block-level elements get stable data-edit-id attributes on document open"
    - "IDs persist when document is saved and reloaded"
    - "New elements created during editing receive IDs"
  artifacts:
    - path: "backend/static/js/element-ids.js"
      provides: "ID assignment and lookup utilities"
      exports: ["ElementIds"]
    - path: "backend/static/js/documents.js"
      provides: "ID assignment integration"
      contains: "ElementIds.assignIds"
  key_links:
    - from: "backend/static/js/documents.js"
      to: "backend/static/js/element-ids.js"
      via: "ElementIds.assignIds() call in openDocument()"
      pattern: "ElementIds\\.assignIds"
---

<objective>
Create stable element ID infrastructure for reliable change targeting.

Purpose: Enable changes to target elements by stable ID rather than fragile content matching. This is the foundation that enables all other improvements.

Output: New `element-ids.js` module with ID assignment utilities, integrated into document lifecycle.
</objective>

<execution_context>
@/Users/pax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pax/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-claude-changes-overhaul/01-CONTEXT.md
@.planning/phases/01-claude-changes-overhaul/01-RESEARCH.md
@backend/static/js/documents.js
@backend/static/js/storage.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create element-ids.js module</name>
  <files>backend/static/js/element-ids.js</files>
  <action>
Create new file `backend/static/js/element-ids.js` with ElementIds module:

```javascript
/**
 * Stable Element ID Management
 * Assigns and manages data-edit-id attributes for reliable change targeting
 */
const ElementIds = {
    // Block-level tags that should receive edit IDs
    BLOCK_TAGS: ['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'LI', 'DIV', 'BLOCKQUOTE', 'PRE', 'UL', 'OL'],

    /**
     * Assign stable IDs to all block-level elements in editor
     * Safe to re-call - skips elements that already have IDs
     * @param {Element} editorRoot - The root element of the editor
     */
    assignIds(editorRoot) {
        if (!editorRoot) return;

        const walker = document.createTreeWalker(
            editorRoot,
            NodeFilter.SHOW_ELEMENT,
            {
                acceptNode: (node) => {
                    // Only block-level elements, skip if already has ID
                    if (this.BLOCK_TAGS.includes(node.tagName) && !node.dataset.editId) {
                        return NodeFilter.FILTER_ACCEPT;
                    }
                    return NodeFilter.FILTER_SKIP;
                }
            }
        );

        while (walker.nextNode()) {
            walker.currentNode.dataset.editId = crypto.randomUUID();
        }
    },

    /**
     * Find element by its stable ID
     * @param {Element} container - Container to search within
     * @param {string} editId - The data-edit-id value to find
     * @returns {Element|null}
     */
    findById(container, editId) {
        if (!container || !editId) return null;
        return container.querySelector(`[data-edit-id="${editId}"]`);
    },

    /**
     * Ensure all elements have IDs (alias for assignIds for clarity)
     * Call after content insertion or Squire format operations
     * @param {Element} editorRoot - The root element of the editor
     */
    ensureIds(editorRoot) {
        this.assignIds(editorRoot);
    },

    /**
     * Get ID from element, assigning one if missing
     * @param {Element} element - Element to get/assign ID for
     * @returns {string|null} The element's edit ID
     */
    getOrCreateId(element) {
        if (!element || element.nodeType !== 1) return null;

        if (!element.dataset.editId) {
            element.dataset.editId = crypto.randomUUID();
        }
        return element.dataset.editId;
    },

    /**
     * Count elements with IDs in container (for debugging)
     * @param {Element} container - Container to count within
     * @returns {number}
     */
    countIds(container) {
        if (!container) return 0;
        return container.querySelectorAll('[data-edit-id]').length;
    }
};
```

Key design decisions:
- Uses TreeWalker for efficient traversal (browser-optimized, handles edge cases)
- Uses crypto.randomUUID() for secure, native ID generation
- Safe to re-call (idempotent) - skips elements that already have IDs
- BLOCK_TAGS list covers all block-level elements Squire produces
  </action>
  <verify>
File exists at `backend/static/js/element-ids.js` and contains ElementIds object with assignIds, findById, ensureIds, getOrCreateId methods.
  </verify>
  <done>
ElementIds module exists with all required methods for ID assignment and lookup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add element-ids.js script tag to index.html</name>
  <files>backend/templates/index.html</files>
  <action>
Add script tag for element-ids.js in the appropriate loading order in `backend/templates/index.html`.

Find the existing script tags section (near bottom of file) and add element-ids.js BEFORE documents.js since Documents will depend on it:

```html
<!-- Add BEFORE documents.js -->
<script src="/static/js/element-ids.js"></script>
<script src="/static/js/documents.js"></script>
```

The load order should be:
1. storage.js (no dependencies)
2. ui.js (no dependencies)
3. components.js (uses UI)
4. element-ids.js (NEW - no dependencies)
5. documents.js (uses ElementIds)
6. ... rest of modules
  </action>
  <verify>
In `backend/templates/index.html`, verify the script tag `<script src="/static/js/element-ids.js"></script>` appears BEFORE the documents.js script tag.
  </verify>
  <done>
element-ids.js is loaded in correct dependency order before documents.js.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate ID assignment into document lifecycle</name>
  <files>backend/static/js/documents.js</files>
  <action>
Modify `backend/static/js/documents.js` to assign IDs at the right points in the document lifecycle:

1. **In openDocument() method** - After setHTML() completes but before any UI updates:

Find the openDocument method (around line 254) and add ID assignment after content is loaded:

```javascript
openDocument(documentId) {
    // ... existing code that sets _loadingDocument = true and calls setHTML() ...

    // After setHTML(), add:
    // Assign stable element IDs for change tracking
    if (typeof ElementIds !== 'undefined') {
        ElementIds.assignIds(this.squireEditor.getRoot());
    }

    // ... rest of existing openDocument code ...
}
```

2. **In saveCurrentDocument() method** - Content already has IDs, they persist in saved HTML (no action needed - IDs are in HTML attributes).

3. **In applyClaudeEdits() method** - Ensure IDs exist before processing changes:

Find applyClaudeEdits (around line 1838) and add:

```javascript
applyClaudeEdits(changes) {
    // ... existing validation code ...

    // Ensure all elements have IDs before processing
    if (typeof ElementIds !== 'undefined' && this.squireEditor) {
        ElementIds.ensureIds(this.squireEditor.getRoot());
    }

    // ... rest of existing code ...
}
```

4. **After Squire format operations** (optional but recommended) - In case Squire strips attributes during some operations, add ensureIds call in the formatXxx methods or after batch operations. This is defensive - test first to see if needed.

Key points:
- Check `typeof ElementIds !== 'undefined'` for graceful degradation
- Call assignIds() after setHTML() in openDocument
- Call ensureIds() before processing changes in applyClaudeEdits
  </action>
  <verify>
1. Open a document in the app
2. Open browser DevTools console
3. Run: `document.querySelectorAll('[data-edit-id]').length`
4. Should return a count > 0 matching the number of block elements
5. Refresh page, reopen same document - IDs should persist (same count)
  </verify>
  <done>
Documents opened in the editor have stable data-edit-id attributes on all block-level elements. IDs persist across save/reload cycles.
  </done>
</task>

</tasks>

<verification>
1. Create a new document with multiple paragraphs
2. Check DevTools: `document.querySelectorAll('[data-edit-id]').length` returns count matching paragraph count
3. Reload page, reopen document - same count persists
4. Add new paragraph - run `ElementIds.assignIds(Documents.squireEditor.getRoot())` - new paragraph gets ID
5. No console errors during document open/save/edit operations
</verification>

<success_criteria>
- ElementIds module loaded and accessible globally
- All block-level elements receive unique data-edit-id attributes
- IDs persist in saved document HTML
- ensureIds() can be called to add IDs to new elements
- No regression in existing document functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-claude-changes-overhaul/01-01-SUMMARY.md`
</output>
