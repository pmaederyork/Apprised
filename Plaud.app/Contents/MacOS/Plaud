#!/bin/bash

# Plaud Chat Desktop Application
# This launches the Plaud Chat web application

# Get the absolute path to the backend directory
# This works regardless of where the .app bundle is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_BUNDLE_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"
PROJECT_DIR="$(dirname "$APP_BUNDLE_DIR")"
BACKEND_DIR="$PROJECT_DIR/backend"

# Set working directory and check if it exists
if [ ! -d "$BACKEND_DIR" ]; then
    osascript -e "display dialog \"Backend directory $BACKEND_DIR not found. Please ensure the Plaud.app is in the correct location relative to the backend folder.\" buttons {\"OK\"} default button \"OK\""
    exit 1
fi

cd "$BACKEND_DIR"

# Function to focus existing Chrome tab or return false if not found
focus_existing_chrome_tab() {
    result=$(osascript <<EOF
tell application "Google Chrome"
    if it is running then
        repeat with w in (windows)
            set j to 0
            repeat with t in (tabs of w)
                set j to j + 1
                if URL of t is "http://127.0.0.1:5000/" then
                    set (active tab index of w) to j
                    set index of w to 1
                    activate
                    return "true"
                end if
            end repeat
        end repeat
    end if
    return "false"
end tell
EOF
)
    [[ "$result" == "true" ]]
}

# Check if Python 3 is available
if ! command -v python3 &> /dev/null; then
    osascript -e 'display dialog "Python 3 is required but not installed. Please install Python 3 and try again." buttons {"OK"} default button "OK"'
    exit 1
fi

# Check if the Python script exists
if [ ! -f "app.py" ]; then
    osascript -e "display dialog \"app.py not found in $BACKEND_DIR\" buttons {\"OK\"} default button \"OK\""
    exit 1
fi

# Check if server is already running
if lsof -Pi :5000 -sTCP:LISTEN -t >/dev/null 2>&1; then
    # Server is already running, try to focus existing Chrome tab
    if focus_existing_chrome_tab; then
        osascript -e 'display notification "Focused existing Plaud tab" with title "Plaud"'
    else
        open -a "Google Chrome" "http://127.0.0.1:5000"
        osascript -e 'display notification "Opened new Plaud tab" with title "Plaud"'
    fi
    exit 0
fi

# Install dependencies if requirements.txt exists
if [ -f "requirements.txt" ]; then
    python3 -m pip install -r requirements.txt --user --quiet
fi

# Start the Flask application in the background with proper error handling
arch -arm64 python3 app.py > /tmp/plaud_chat.log 2>&1 &
SERVER_PID=$!

# Wait for server to start
sleep 4

# Check if server started successfully
if lsof -Pi :5000 -sTCP:LISTEN -t >/dev/null 2>&1; then
    # Open the application in Chrome
    open -a "Google Chrome" "http://127.0.0.1:5000"
    
    # Show success notification
    osascript -e 'display notification "Plaud Chat is now running at http://127.0.0.1:5000" with title "Plaud Started"'
else
    # Server failed to start, show error with log details
    ERROR_LOG=$(tail -n 5 /tmp/plaud_chat.log 2>/dev/null || echo "No error log available")
    osascript -e "display dialog \"Failed to start Plaud Chat server.\\n\\nError details:\\n$ERROR_LOG\" buttons {\"OK\"} default button \"OK\""
    exit 1
fi